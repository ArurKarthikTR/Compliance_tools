<div class="back-button-container">
  <button class="back-button" (click)="goBackToUpload()">‚Üê Back to Upload</button>
</div>

<div class="comparison-results" *ngIf="comparisonData">
  <h2>Comparison Results - {{ fileType.toUpperCase() }}</h2>
  
  <div class="view-controls">
    <label class="view-control-label">
      <input type="checkbox" [(ngModel)]="showOnlyDifferences" (change)="toggleDifferencesOnly()">
      {{ fileType === 'xml' ? 'Show only changed values' : 'Show only differences' }}
    </label>
  </div>
  
  
  <!-- XML file type view -->
  <div class="table-container" *ngIf="fileType === 'xml'">
    <!-- Color legend above the table -->
    <div class="color-legend">
      <div class="legend-item">
        <span class="color-box changed-value-box"></span>
        <span>Changed Value</span>
      </div>
      <div class="legend-item">
        <span class="color-box source-only-box"></span>
        <span>Only in Source</span>
      </div>
      <div class="legend-item">
        <span class="color-box target-only-box"></span>
        <span>Only in Target</span>
      </div>
      <div class="legend-item">
        <span class="color-box match-value-box"></span>
        <span>Matching Values</span>
      </div>
    </div>
    
    <table class="comparison-table simplified">
      <thead>
        <tr>
          <th>NODE PATH</th>
          <th>SOURCE VALUE</th>
          <th>TARGET VALUE</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let row of processedRows; let i = index" [ngClass]="{'row-divider': i > 0}">
          <td class="path-cell">
            <div class="node-path">{{ cleanNodePath(row.path) }}</div>
          </td>
          <!-- SOURCE COLUMN - Apply Red for different in source -->
          <td>
            <!-- Different value in source - show in RED -->
            <span *ngIf="row.status === 'different' && row.sourceValue !== null && row.sourceValue !== undefined" 
                  class="source-diff-value">
              {{ row.sourceValue }}
            </span>
            <!-- Source-only value (Blue) -->
            <span *ngIf="row.status === 'source_only'" class="source-only">
              {{ row.sourceValue }}
            </span>
            <!-- Value exists in both and is the same - show in orange -->
            <span *ngIf="row.status === 'match' && row.sourceValue !== null && row.sourceValue !== undefined" class="match-value">
              {{ row.sourceValue }}
            </span>
            <!-- Empty value -->
            <span *ngIf="(row.sourceValue === null || row.sourceValue === undefined) && row.status !== 'target_only'" class="empty-value">(empty)</span>
            <!-- For target-only rows, leave source column truly empty -->
            <span *ngIf="row.status === 'target_only'"></span>
          </td>
          <!-- TARGET COLUMN - Apply Red for different in target -->
          <td>
            <!-- Different value in target - now show in RED -->
            <span *ngIf="row.status === 'different' && row.targetValue !== null && row.targetValue !== undefined" 
                  class="target-diff-value">
              {{ row.targetValue }}
            </span>
            <!-- Target-only value (Grey) -->
            <span *ngIf="row.status === 'target_only'" class="target-only">
              {{ row.targetValue }}
            </span>
            <!-- Value exists in both and is the same - show in orange -->
            <span *ngIf="row.status === 'match' && row.targetValue !== null && row.targetValue !== undefined" class="match-value">
              {{ row.targetValue }}
            </span>
            <!-- Empty value -->
            <span *ngIf="(row.targetValue === null || row.targetValue === undefined) && row.status !== 'source_only'" class="empty-value">(empty)</span>
            <!-- For source-only rows, leave target column truly empty -->
            <span *ngIf="row.status === 'source_only'"></span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  
  <!-- CSV/XLSX file type view - Excel-like format -->
  <div class="table-container excel-view" *ngIf="fileType === 'csv' || fileType === 'xlsx'">
    <div class="table-info" *ngIf="tableData.rows && tableData.rows.length > 0">
      <p>Showing {{ filteredRows.length }} of {{ tableData.rows.length }} rows</p>
    </div>
    <table class="comparison-table excel-style">
      <thead>
        <tr>
          <th *ngFor="let header of tableData.headers">{{ header }}</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let row of filteredRows; let rowIndex = index">
          <td *ngFor="let cell of row; let colIndex = index" 
              [ngClass]="{'row-header': colIndex === 0}">
            <ng-container *ngIf="colIndex === 0">
              {{ cell }}
            </ng-container>
            <ng-container *ngIf="colIndex > 0">
              <!-- Check if this cell has a difference -->
              <ng-container *ngIf="tableData.diffValueMap && tableData.headers && tableData.headers[colIndex] && tableData.diffValueMap.has(rowIndex + '-' + tableData.headers[colIndex])">
                <div class="diff-cell">
                  <span class="original-value">{{ tableData.diffValueMap.get(rowIndex + '-' + tableData.headers[colIndex])?.original }}</span>
                  <span class="changed-value">{{ tableData.diffValueMap.get(rowIndex + '-' + tableData.headers[colIndex])?.changed }}</span>
                </div>
              </ng-container>
              
              <!-- Regular cell without difference -->
              <ng-container *ngIf="!tableData.diffValueMap || !tableData.headers || !tableData.headers[colIndex] || !tableData.diffValueMap.has(rowIndex + '-' + tableData.headers[colIndex])">
                <span *ngIf="cell !== null && cell !== undefined"
                      [ngClass]="tableData.headers && tableData.headers[colIndex] ? getCellClass(rowIndex, tableData.headers[colIndex]) : ''">
                  {{ cell }}
                </span>
                <span *ngIf="cell === null || cell === undefined" class="empty-value">(empty)</span>
              </ng-container>
            </ng-container>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  
  <!-- Summary stats and legend below the comparison table -->
  <div class="summary-container">
    <div class="summary-item">
      <span class="label">TOTAL NODES:</span>
      <span class="value">{{ summary.totalRows || 0 }}</span>
    </div>
    <div class="summary-item">
      <span class="label">MATCHING NODES:</span>
      <span class="value" style="color: #00a65a;">{{ summary.matchingRows || 0 }}</span>
    </div>
    <div class="summary-item">
      <span class="label">DIFFERING NODES:</span>
      <span class="value" style="color: #dd4b39;">{{ summary.differingRows || 0 }}</span>
    </div>
    <div class="summary-item">
      <span class="label">VALUES CHANGED:</span>
      <span class="value" style="color: #f39c12;">{{ tableData.changedValuesCount || 0 }}</span>
    </div>
    <div class="summary-item">
      <span class="label">VALUES ONLY IN SOURCE:</span>
      <span class="value" style="color: #0076CE;">{{ tableData.removedValuesCount || 0 }}</span>
    </div>
    <div class="summary-item">
      <span class="label">VALUES ONLY IN TARGET:</span>
      <span class="value" style="color: #666666;">{{ tableData.targetOnlyCount || 0 }}</span>
    </div>
  </div>
  
  
  <button class="download-button" (click)="downloadResults()">
    Download Results
  </button>
</div>

<div class="no-results" *ngIf="!comparisonData">
  <p>No comparison results to display. Please upload and compare files.</p>
</div>
